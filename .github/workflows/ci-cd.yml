name: MLOPs CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  lint:
    name: Code Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install linting dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black
    
    - name: Run flake8
      run: |
        echo "=== Running flake8 linting ==="
        flake8 Part1 Part2 Part3 Part4 Part5 --count --max-line-length=120 \
          --extend-ignore=E203,W503,E265,E302,E402,E501,W291,W293,W391,E128 \
          --statistics --show-source || {
          echo "ERROR: Flake8 found linting errors!"
          exit 1
        }
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: Download dataset
      run: |
        echo "=== Downloading dataset ==="
        python Part1/dataset_download_script/download_data.py || {
          echo "ERROR: Failed to download dataset!"
          exit 1
        }
    
    - name: Preprocess data
      run: |
        echo "=== Preprocessing data ==="
        python Part1/src/data_preprocess.py || {
          echo "ERROR: Failed to preprocess data!"
          exit 1
        }
    
    - name: Train and package model for tests
      run: |
        echo "=== Training and packaging model ==="
        python Part2/src/train_models.py || {
          echo "ERROR: Failed to train models!"
          exit 1
        }
        python Part4/src/package_model.py || {
          echo "ERROR: Failed to package model!"
          exit 1
        }
    
    - name: Run tests with pytest
      run: |
        echo "=== Running unit tests ==="
        cd Part5
        pytest -v --tb=short --junit-xml=test-results.xml || {
          echo "ERROR: Tests failed! Check logs above for details."
          exit 1
        }
    
    - name: Run tests with coverage
      run: |
        echo "=== Running tests with coverage ==="
        cd Part5
        pytest --cov=../Part1 --cov=../Part2 --cov=../Part4 \
          --cov-report=xml --cov-report=html --cov-report=term \
          --cov-fail-under=50 || {
          echo "ERROR: Coverage below threshold or tests failed!"
          exit 1
        }
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: Part5/test-results.xml
    
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: Part5/htmlcov/

  train:
    name: Model Training
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        echo "=== Installing dependencies ==="
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Download and preprocess data
      run: |
        echo "=== Downloading and preprocessing data ==="
        python Part1/dataset_download_script/download_data.py || {
          echo "ERROR: Failed to download dataset!"
          exit 1
        }
        python Part1/src/data_preprocess.py || {
          echo "ERROR: Failed to preprocess data!"
          exit 1
        }
    
    - name: Clean MLflow artifacts and model outputs
      run: |
        echo "=== Cleaning artifacts ==="
        rm -f mlflow.db
        rm -rf mlruns/
        rm -rf Part3/mlruns/
        rm -rf Part2/outputs/
        rm -rf Part3/outputs/
        rm -rf Part4/models/
        rm -rf Part4/metrics/
    
    - name: Train models (Part 2)
      run: |
        echo "=== Training models (Part 2) ==="
        python Part2/src/train_models.py || {
          echo "ERROR: Part 2 training failed!"
          exit 1
        }
    
    - name: Train with MLflow (Part 3)
      run: |
        echo "=== Training with MLflow (Part 3) ==="
        python Part3/src/train_with_mlflow.py || {
          echo "ERROR: Part 3 MLflow training failed!"
          exit 1
        }
    
    - name: Package final model (Part 4)
      run: |
        echo "=== Packaging final model (Part 4) ==="
        python Part4/src/package_model.py || {
          echo "ERROR: Model packaging failed!"
          exit 1
        }
    
    - name: Upload trained models
      uses: actions/upload-artifact@v4
      with:
        name: trained-models
        path: |
          Part2/outputs/models/
          Part3/outputs/models/
          Part4/models/
    
    - name: Upload metrics
      uses: actions/upload-artifact@v4
      with:
        name: model-metrics
        path: |
          Part2/outputs/metrics/
          Part3/outputs/metrics/
          Part4/metrics/
    
    - name: Upload plots
      uses: actions/upload-artifact@v4
      with:
        name: model-plots
        path: |
          Part1/reports/figures/
          Part2/outputs/plots/
          Part3/outputs/plots/
    
    - name: Upload MLflow tracking
      uses: actions/upload-artifact@v4
      with:
        name: mlflow-runs
        path: Part3/mlruns/

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [lint, test, train]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Generate build summary
      run: |
        echo "# MLOps Pipeline Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Job Status" >> $GITHUB_STEP_SUMMARY
        echo "- **Linting:** ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Testing:** ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Training:** ${{ needs.train.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Add failure details if any job failed
        if [ "${{ needs.lint.result }}" = "failure" ]; then
          echo "**ERROR: Linting failed** - Check flake8/black output" >> $GITHUB_STEP_SUMMARY
        fi
        if [ "${{ needs.test.result }}" = "failure" ]; then
          echo "**ERROR: Tests failed** - Check pytest output and test-results artifact" >> $GITHUB_STEP_SUMMARY
        fi
        if [ "${{ needs.train.result }}" = "failure" ]; then
          echo "**ERROR: Training failed** - Check training logs" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Pipeline completed!" >> $GITHUB_STEP_SUMMARY